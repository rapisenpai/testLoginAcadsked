function formatPhoneNumber(input){let value=input.value.replace(/\D/g,'');if(value.length>7){value=value.slice(0,4)+'-'+value.slice(4,7)+'-'+value.slice(7);}else if(value.length>4){value=value.slice(0,4)+'-'+value.slice(4);}
input.value=value;validatePhoneNumber(input,false);}
function validatePhoneNumber(input,showSuccessMessage=true){const phoneHelper=document.getElementById('phone-helper');const phoneValue=input.value.replace(/-/g,'');const validLength=11;phoneHelper.classList.remove('text-red-600');phoneHelper.textContent='';let isValid=true;if(phoneValue.length!==0&&(phoneValue.length!==validLength||!phoneValue.startsWith('09'))){phoneHelper.textContent='Phone number must be valid and 11 digits long.';phoneHelper.classList.add('text-red-600','mt-2');isValid=false;}else if(phoneValue.length!==0&&showSuccessMessage){}
return isValid;}
function validateEmail(showSuccessMessage=true){const emailInput=document.getElementById('email');const emailHelper=document.getElementById('email-helper');const emailValue=emailInput.value;const domain='@dnsc.edu.ph';emailHelper.classList.remove('text-red-600');emailHelper.textContent='';const emailRegex=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;let isValid=true;if(emailValue===''){emailHelper.textContent='Email cannot be blank.';emailHelper.classList.add('text-red-600','mt-2');isValid=false;}else if(!emailRegex.test(emailValue)||!emailValue.endsWith(domain)){emailHelper.textContent=`Email must end with ${domain}.`;emailHelper.classList.add('text-red-600','mt-2');isValid=false;}else if(showSuccessMessage){}
return isValid;}
function updatePersonalInfoButtonState(){const firstNameInput=document.getElementById('first_name');const lastNameInput=document.getElementById('last_name');const emailInput=document.getElementById('email');const phoneInput=document.getElementById('phone_number');const personalInfoButton=document.getElementById('personalInfoButton');const fullNameHelper=document.getElementById('full-name-helper');const firstName=firstNameInput.value.trim();const lastName=lastNameInput.value.trim();const email=emailInput.value.trim();const isValidEmail=validateEmail(false);const isValidPhone=validatePhoneNumber(phoneInput,false);if(!firstName&&!lastName){fullNameHelper.textContent='First and last name cannot be blank.';fullNameHelper.classList.add('text-xs','mt-2','text-red-600');}else if(!firstName){fullNameHelper.textContent='First name cannot be blank.';fullNameHelper.classList.add('text-xs','mt-2','text-red-600');}else if(!lastName){fullNameHelper.textContent='Last name cannot be blank.';fullNameHelper.classList.add('text-xs','mt-2','text-red-600');}else{fullNameHelper.textContent='';fullNameHelper.classList.remove('text-xs','mt-2','text-red-600');}
personalInfoButton.disabled=!(firstName&&lastName&&isValidEmail&&(phoneInput.value.trim()===''||isValidPhone));}
document.addEventListener('DOMContentLoaded',function(){const firstNameInput=document.getElementById('first_name');const lastNameInput=document.getElementById('last_name');const emailInput=document.getElementById('email');const phoneInput=document.getElementById('phone_number');firstNameInput.addEventListener('input',updatePersonalInfoButtonState);lastNameInput.addEventListener('input',updatePersonalInfoButtonState);emailInput.addEventListener('input',updatePersonalInfoButtonState);phoneInput.addEventListener('input',function(){formatPhoneNumber(this);updatePersonalInfoButtonState();});updatePersonalInfoButtonState();});document.getElementById('personalInformation').addEventListener('submit',function(event){const phoneInput=document.getElementById('phone_number');const phoneValue=phoneInput.value.trim();phoneInput.value=phoneValue.replace(/-/g,'');if(phoneValue!==''&&!validatePhoneNumber(phoneInput,false)||!validateEmail(false)){event.preventDefault();}});;document.addEventListener('DOMContentLoaded',function(){const currentPasswordInput=document.getElementById('current-password');const newPasswordInput=document.getElementById('new-password');const confirmPasswordInput=document.getElementById('confirm-password');const passwordButton=document.getElementById('otp_button');const newPasswordHelper=document.getElementById('new-password-helper');const confirmPasswordHelper=document.getElementById('confirm-password-helper');const togglePasswordCheckbox=document.getElementById('toggle-password');function updatePasswordButtonState(){const currentPassword=currentPasswordInput.value.trim();const newPassword=newPasswordInput.value.trim();const confirmPassword=confirmPasswordInput.value.trim();const passwordValid=validateNewPassword(currentPassword,newPassword);const passwordsMatch=validateConfirmPassword(newPassword,confirmPassword);passwordButton.disabled=!(currentPassword&&newPassword&&confirmPassword&&passwordValid&&passwordsMatch);}
function validateNewPassword(currentPassword,newPassword){const minLength=6;const lowercasePattern=/[a-z]/;const uppercasePattern=/[A-Z]/;const numberPattern=/[0-9]/;const specialCharPattern=/[!@#$%^&*(),.?":{}|<>]/;let message="Your password must contain:<br>";let valid=true;if(newPassword===currentPassword){message+="- New password must be different from current password.<br>";valid=false;}
if(newPassword.length<minLength){message+=`- Minimum number of characters is ${minLength}.<br>`;valid=false;}
if(!lowercasePattern.test(newPassword)){message+="- Should contain lowercase.<br>";valid=false;}
if(!uppercasePattern.test(newPassword)){message+="- Should contain uppercase.<br>";valid=false;}
if(!numberPattern.test(newPassword)){message+="- Should contain numbers.<br>";valid=false;}
if(!specialCharPattern.test(newPassword)){message+="- Should contain special characters.<br>";valid=false;}
if(valid){newPasswordHelper.style.display='none';}else{newPasswordHelper.style.display='block';newPasswordHelper.innerHTML=message;}
return valid;}
function validateConfirmPassword(newPassword,confirmPassword){if(confirmPassword&&newPassword!==confirmPassword){confirmPasswordHelper.innerHTML="Your password does not match";confirmPasswordHelper.style.display='block';return false;}else{confirmPasswordHelper.innerHTML="";confirmPasswordHelper.style.display='none';return true;}}
function togglePasswordVisibility(){const type=togglePasswordCheckbox.checked?'text':'password';currentPasswordInput.type=type;newPasswordInput.type=type;confirmPasswordInput.type=type;}
currentPasswordInput.addEventListener('input',updatePasswordButtonState);newPasswordInput.addEventListener('input',updatePasswordButtonState);confirmPasswordInput.addEventListener('input',updatePasswordButtonState);togglePasswordCheckbox.addEventListener('change',togglePasswordVisibility);updatePasswordButtonState();});let countdownInterval;function sendOtp(){var form=document.getElementById('managePassword');var formData=new FormData(form);formData.append('send_otp','true');var xhr=new XMLHttpRequest();xhr.open('POST','',true);xhr.setRequestHeader('X-CSRFToken','{{ csrf_token }}');xhr.onload=function(){if(xhr.status===200){document.getElementById('totp_modal').classList.remove('hidden');document.getElementById('otp_button').disabled=true;startCountdown();}else{document.getElementById('otp-password-helper').innerText='Failed to send OTP. Please try again.';}};xhr.send(formData);}
function startCountdown(){var countdownElement=document.getElementById('otp-password-countdown');var minutes=2;var seconds=0;function updateCountdown(){if(seconds===0){if(minutes===0){clearInterval(countdownInterval);document.getElementById('otp_button').disabled=false;countdownElement.innerText='OTP expired';return;}
minutes--;seconds=59;}else{seconds--;}
var minText=minutes<10?'0'+minutes:minutes;var secText=seconds<10?'0'+seconds:seconds;countdownElement.innerText=minText+':'+secText;}
updateCountdown();countdownInterval=setInterval(updateCountdown,1000);};